# Nhật ký làm việc — 2025-09-21 (phiên 01)

Mục tiêu chính trong ngày: (1) Gỡ endpoint ingest all-approved, (2) Chuẩn hoá import/export Excel theo 4 sheet chuyên biệt (Products, Campaigns, Commissions, Promotions), (3) Đảm bảo cột phản ánh đúng tài liệu API (đọc từ PDF), (4) Giữ dòng tiêu đề tiếng Việt khi export và import tự bỏ qua.

---

## 1) Tổng quan yêu cầu & phạm vi
- Bỏ hẳn endpoint `POST /ingest/v2/offers/all-approved`.
- Giữ nguyên các endpoint ingest còn lại (datafeeds, promotions, top-products, campaigns sync).
- Refactor logic Excel: export thành 4 sheet chuyên biệt và import đọc từ sheet `Products` nhưng vẫn tương thích file export (bỏ qua hàng header tiếng Việt).
- Cột trong Excel phản ánh đúng cấu trúc Accesstrade (tham chiếu `docs/API Reference.pdf`).
- Nếu không đọc được PDF tại môi trường, chuyển đổi sang text/markdown để phân tích.

## 2) Công việc đã thực hiện

### 2.1. Gỡ endpoint all-approved
- Đã xóa model request và route `POST /ingest/v2/offers/all-approved` trong `backend/main.py`.
- Các endpoint ingest khác giữ nguyên: 
	- `POST /ingest/accesstrade/datafeeds/all`
	- `POST /ingest/v2/promotions`
	- `POST /ingest/v2/top-products`
	- `POST /ingest/v2/campaigns/sync`

### 2.2. Refactor Export Excel → 4 sheet
- Endpoint: `GET /offers/export-excel` nay xuất 4 sheet:
	1) `Products`: cột dữ liệu theo datafeeds + một số trường tiện tra cứu từ `extra`.
	2) `Campaigns`: join theo `campaign_id`, bổ sung đủ trường mô tả chiến dịch; fallback theo log JSONL để đánh dấu `API_EMPTY`/`API_MISSING` khi cần.
	3) `Commissions`: gom các chính sách theo campaign, ghép bằng `; `.
	4) `Promotions`: gom khuyến mãi theo campaign, ghép bằng `; `.
- Hàng đầu tiên của mỗi sheet là tiêu đề tiếng Việt (human-readable) — để người dùng dễ đọc. Code import tự động bỏ qua hàng này.

### 2.3. Refactor Import Excel (sheet Products)
- Endpoint: `POST /offers/import-excel`.
- Mặc định đọc sheet `Products`; nếu thiếu, fallback sheet đầu tiên.
- Tự động phát hiện và bỏ qua hàng tiêu đề tiếng Việt (so sánh bản dịch cột với dòng đầu).
- Alias mapping để hỗ trợ các file cũ/khác nguồn: 
	- `source_id|product_id|id`, `merchant|campaign`, `title|name`, `url|landing_url`, `affiliate_url|aff_link`, `image_url|image|thumbnail`.
- Tôn trọng các cờ policy import (lưu trong DB qua API):
	- `only_with_commission`: chỉ nhận hàng có thông tin commission hoặc `eligible_commission`.
	- `check_urls`: chỉ nhận khi `url` sống.

### 2.4. Đồng bộ schema theo tài liệu API (đã parse PDF)
- Do môi trường cục bộ không cài được thư viện, đã dùng container tạm để chuyển `API Reference.pdf` → text (`docs/API-Reference.extracted.txt`) và soạn `docs/API-Reference.md`.
- Cập nhật schema:
	- Products: thêm `domain`, `sku`, `discount`, `discount_amount`, `discount_rate`, `status_discount`.
	- Campaigns: thêm `category`, `conversion_policy`, `cookie_duration`, `cookie_policy`, `description`, `scope`, `sub_category`, `type`, `campaign_url`.
- Giữ nguyên 2 sheet còn lại theo dạng tổng hợp (aggregate) từ DB & logs.

## 3) Chi tiết schema Excel (tóm tắt)

### 3.1. Products — cột kỹ thuật
- `id`, `source`, `source_id`, `merchant`, `title`, `url`, `affiliate_url`, `image_url`, `price`, `currency`, `campaign_id`, `product_id`, `affiliate_link_available`, `domain`, `sku`, `discount`, `discount_amount`, `discount_rate`, `status_discount`, `updated_at`, `desc`, `cate`, `shop_name`, `update_time_raw`, `extra_raw`.

Tiêu đề tiếng Việt tương ứng (hàng 1):
- `Mã ID`, `Nguồn`, `Mã nguồn`, `Nhà bán`, `Tên sản phẩm`, `Link gốc`, `Link tiếp thị`, `Ảnh sản phẩm`, `Giá`, `Tiền tệ`, `Chiến dịch`, `Mã sản phẩm nguồn`, `Có affiliate?`, `Tên miền`, `SKU`, `Giá KM`, `Mức giảm`, `Tỷ lệ giảm (%)`, `Có khuyến mãi?`, `Ngày cập nhật`, `Mô tả chi tiết`, `Danh mục`, `Tên cửa hàng`, `Thời gian cập nhật từ nguồn`, `Extra gốc`.

### 3.2. Campaigns — cột kỹ thuật
- `product_id`, `merchant`, `campaign_id`, `campaign_name`, `approval_type`, `user_status`, `status`, `start_time`, `end_time`, `category`, `conversion_policy`, `cookie_duration`, `cookie_policy`, `description`, `scope`, `sub_category`, `type`, `campaign_url`.

Tiêu đề tiếng Việt tương ứng:
- `ID sản phẩm`, `Nhà bán`, `Mã chiến dịch`, `Tên chiến dịch`, `Approval`, `Trạng thái của tôi`, `Tình trạng`, `Bắt đầu`, `Kết thúc`, `Danh mục chính`, `Chính sách chuyển đổi`, `Hiệu lực cookie (giây)`, `Chính sách cookie`, `Mô tả`, `Phạm vi`, `Danh mục phụ`, `Loại`, `URL chiến dịch`.

### 3.3. Commissions — cột kỹ thuật
- `product_id`, `sales_ratio`, `sales_price`, `reward_type`, `target_month`.

Tiêu đề tiếng Việt tương ứng:
- `ID sản phẩm`, `Tỷ lệ (%)`, `Hoa hồng cố định`, `Kiểu thưởng`, `Tháng áp dụng`.

### 3.4. Promotions — cột kỹ thuật
- `product_id`, `promotion_name`, `promotion_content`, `promotion_start_time`, `promotion_end_time`, `promotion_coupon`, `promotion_link`.

Tiêu đề tiếng Việt tương ứng:
- `ID sản phẩm`, `Tên khuyến mãi`, `Nội dung`, `Bắt đầu KM`, `Kết thúc KM`, `Mã giảm`, `Link khuyến mãi`.

Ghi chú chung:
- Hàng 1 luôn là tiêu đề tiếng Việt (human-readable). Khi import, hệ thống tự bỏ qua.
- `Campaigns`/`Commissions`/`Promotions` là các sheet tham chiếu/tổng hợp để tra cứu; sheet `Products` là nguồn nhập.
- Trường không có dữ liệu/không được API trả về sẽ hiển thị `API_EMPTY` hoặc `API_MISSING` (dựa trên log JSONL).

## 4) Endpoint liên quan & hành vi
- Gỡ: `POST /ingest/v2/offers/all-approved` → 404.
- Giữ nguyên ingest khác: `datafeeds/all`, `v2/promotions`, `v2/top-products`, `v2/campaigns/sync`.
- Import Excel: `POST /offers/import-excel` — đọc `Products`, bỏ qua header tiếng Việt, hỗ trợ alias cột, tôn trọng policy `only_with_commission` và `check_urls`.
- Export Excel: `GET /offers/export-excel` — xuất 4 sheet đồng bộ, có header tiếng Việt.

## 5) Log, nguồn dữ liệu & xử lý thiếu
- Đọc log JSONL trong thư mục `./logs` (nếu có) để gán nhãn `API_EMPTY`/`API_MISSING` cho các trường campaign.
- `Commissions`/`Promotions` được ghép theo `campaign_id` từ DB; trường hợp rỗng sẽ rơi về nhãn từ log.

## 6) Hướng dẫn chạy nhanh (dev)
Backend:
```bash
pip3 install -r backend/requirements.txt
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```
Mở: `http://localhost:8000/docs`

Frontend:
```bash
cd frontend
npm install
npm run dev -- --host
```
Mở: `http://localhost:5173`

## 7) Kết quả & tồn đọng
- Đã hoàn thành:
	- Gỡ endpoint all-approved.
	- Tách export 4 sheet + giữ header tiếng Việt + import tương thích.
	- Cập nhật schema theo tài liệu (Products/Campaigns mở rộng trường).
	- Soạn `docs/API-Reference.md` để tra cứu nhanh.
- Còn lại:
	- Chưa chạy smoke test tự động (cần khởi chạy backend và thử export→import một vòng).
	- Chưa có unit test khóa schema.

## 8) Đề xuất việc ngày mai
- Chạy smoke test:
	1) `GET /offers/export-excel` → tải file.
	2) Upload lại file vào `POST /offers/import-excel` → xác nhận bỏ header OK, alias OK.
- Thêm unit test nhỏ cho:
	- Kiểm tra cột và header tiếng Việt ở cả 4 sheet.
	- Kiểm tra import bỏ qua header + alias mapping.
- (Tuỳ chọn) Bổ sung file Excel mẫu trong `docs/` cho QA.

---

Tài liệu liên quan:
- Mã nguồn: `backend/main.py`
- Tài liệu schema: `docs/API-Reference.md`
- Bản text từ PDF: `docs/API-Reference.extracted.txt`
